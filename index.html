<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Power Log v3.8 - Final Multi-Device Edition</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
    .font-digital { font-family: 'Orbitron', sans-serif; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* Èö±ËóèÂéüÁîüÈÅ∏ÊìáÊ°ÜÁÆ≠È†≠ */
    select { -webkit-appearance: none; appearance: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen p-4 pb-24">
  
  <header class="flex justify-between items-center mb-6 pt-4">
    <div>
      <h1 class="text-2xl font-black italic tracking-tighter text-lime-400">POWER LOG</h1>
      <div class="text-[10px] font-bold text-slate-400 mt-1 uppercase tracking-widest flex items-center gap-1">
        <span class="text-orange-500">üî•</span> {{ streak }} Day Streak
        <span v-if="syncing" class="ml-2 text-[8px] text-lime-500 animate-pulse">‚óè Syncing</span>
      </div>
    </div>
    <div class="bg-slate-900 p-1 rounded-xl flex border border-slate-800 shadow-inner">
      <button v-for="u in ['JW', 'EP']" @click="switchUser(u)" 
              :class="user === u ? (u === 'JW' ? 'bg-lime-400 text-black' : 'bg-orange-500 text-white') : 'text-slate-500'"
              class="px-5 py-1.5 rounded-lg font-bold transition-all text-sm uppercase">{{ u }}</button>
    </div>
  </header>

  <div v-if="userTimers[user] > 0" class="mb-6 rounded-3xl overflow-hidden shadow-[0_0_40px_rgba(0,0,0,0.6)] animate-fadeIn">
    <div :class="user === 'JW' ? 'bg-lime-400 text-black' : 'bg-orange-500 text-white'" class="p-8 text-center transition-colors duration-500">
      <p class="text-[10px] font-black uppercase mb-1 opacity-60 tracking-[0.3em]">Rest Interval</p>
      <div class="text-7xl font-digital leading-none mb-6">{{ userTimers[user] }}s</div>
      <button @click="skipRest" class="bg-black/10 hover:bg-black/20 px-8 py-2.5 rounded-full text-[10px] font-black uppercase border border-black/10 backdrop-blur-sm transition-all active:scale-95">Skip Rest</button>
    </div>
  </div>

  <div class="glass rounded-3xl p-6 mb-6 shadow-2xl">
    <div class="space-y-5">
      <div>
        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Exercise Selection</label>
        <div class="relative">
          <select v-model="form.exercise" class="w-full bg-slate-800/50 rounded-xl p-3.5 mt-1.5 text-sm outline-none ring-1 ring-slate-700 focus:ring-2 ring-lime-400/50 transition-all">
            <optgroup v-for="(list, cat) in actionLibrary[user]" :label="cat" class="bg-slate-900 text-slate-400">
              <option v-for="ex in list" :value="ex" class="text-white">{{ ex }}</option>
            </optgroup>
          </select>
          <div class="absolute right-4 top-1/2 mt-1 pointer-events-none text-slate-500">‚ñº</div>
        </div>
      </div>

      <div v-if="isTimed" class="space-y-2">
        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1 text-lime-400">Hold Time (Seconds)</label>
        <input v-model.number="form.duration" type="number" inputmode="numeric" placeholder="0" class="w-full bg-slate-800 rounded-2xl p-5 text-3xl font-black text-center text-lime-400 outline-none ring-1 ring-slate-700 shadow-inner focus:ring-2 ring-lime-400 transition-all">
      </div>
      
      <div v-else class="grid grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Weight (kg)</label>
          <input v-model.number="form.weight" type="number" step="0.5" inputmode="decimal" placeholder="0" class="w-full bg-slate-800 rounded-xl p-4 text-xl font-bold text-center outline-none ring-1 ring-slate-700 focus:ring-2 ring-lime-400 transition-all">
        </div>
        <div class="space-y-2">
          <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Reps</label>
          <input v-model.number="form.reps" type="number" inputmode="numeric" placeholder="0" class="w-full bg-slate-800 rounded-xl p-4 text-xl font-bold text-center outline-none ring-1 ring-slate-700 focus:ring-2 ring-lime-400 transition-all">
        </div>
      </div>

      <div v-if="user === 'EP'" class="flex justify-between items-center bg-red-500/10 p-4 rounded-xl border border-red-500/20">
        <div>
          <span class="block text-xs font-bold text-red-400 italic">Shoulder / Neck Pain?</span>
          <span class="text-[8px] text-red-500/60 uppercase font-bold tracking-tighter">Affects recovery score</span>
        </div>
        <input type="checkbox" v-model="form.pain" class="w-6 h-6 accent-red-500 rounded-lg cursor-pointer">
      </div>

      <div class="flex gap-2">
        <button v-for="t in [60, 90, 120]" @click="form.rest = t"
                :class="form.rest === t ? (user === 'JW' ? 'bg-lime-400 text-black' : 'bg-orange-500 text-white') : 'bg-slate-800 text-slate-500'"
                class="flex-1 py-2.5 rounded-xl font-black text-[10px] transition-all uppercase tracking-tighter shadow-md">{{ t }}s Rest</button>
      </div>

      <button @click="logData" :disabled="loading" 
              class="w-full bg-white text-black font-black py-4.5 rounded-2xl active:scale-[0.97] transition-all shadow-xl uppercase tracking-[0.2em] text-sm flex justify-center items-center gap-2">
        <span v-if="loading" class="animate-spin text-lg">üåÄ</span>
        {{ loading ? 'Updating Sheet...' : 'Log Set & Start Rest' }}
      </button>
    </div>
  </div>

  <div class="glass rounded-3xl p-5 mb-6 shadow-xl">
    <div class="flex justify-between items-center mb-4 px-1">
      <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Training Days</span>
      <span class="text-[9px] font-bold text-slate-600 uppercase">{{ currentMonthName }}</span>
    </div>
    <div class="grid grid-cols-7 gap-y-3 text-center">
      <div v-for="d in ['S','M','T','W','T','F','S']" class="text-[9px] font-black text-slate-700 uppercase">{{ d }}</div>
      <div v-for="e in calendarOffset" class="aspect-square"></div>
      <div v-for="d in daysInMonth" :key="d" class="relative group py-1">
        <span :class="isToday(d) ? 'text-lime-400 font-black ring-1 ring-lime-400/20 px-1.5 py-0.5 rounded shadow-[0_0_10px_rgba(163,230,53,0.2)]' : 'text-slate-600'" class="text-[11px]">{{ d }}</span>
        <div v-if="hasLog(d)" 
             :class="[user === 'JW' ? 'bg-lime-400' : 'bg-orange-500', getDayStats(d).hasPain ? 'ring-2 ring-red-500 ring-offset-1 ring-offset-slate-900' : '']" 
             class="w-1.5 h-1.5 rounded-full mx-auto mt-1.5 shadow-sm"></div>
      </div>
    </div>
  </div>

  <div class="space-y-3">
    <div class="flex justify-between items-center px-2">
      <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Daily Performance</h3>
      <span class="text-[10px] font-bold text-slate-600 tracking-tighter">VOL: {{ formatVol(dailyVol) }}kg</span>
    </div>
    <div v-if="todayLogs.length === 0" class="text-center py-10 text-slate-700 text-xs italic bg-slate-900/10 rounded-3xl border border-dashed border-slate-800">
      Ready for the first set?
    </div>
    <div v-for="(log, i) in todayLogs" :key="i" 
         :class="log.pain === 'Yes' || log.pain === 'TRUE' || log.pain === true ? 'border-red-500/50 bg-red-500/5' : 'border-slate-800 bg-slate-900/40'" 
         class="border border-l-4 p-4 rounded-2xl flex justify-between items-center transition-all animate-fadeIn shadow-sm">
      <div class="flex-1">
        <div class="font-bold text-sm tracking-tight">{{ log.exercise }}</div>
        <div class="text-[10px] text-slate-500 font-medium mt-0.5">
          <span v-if="log.duration > 0" class="text-lime-400/80">{{ log.duration }}s Hold</span>
          <span v-else>{{ log.weight }}kg √ó {{ log.reps }} Reps</span>
        </div>
      </div>
      <div class="text-right">
        <div v-if="log.weight > 0" class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">{{ log.weight * log.reps }}kg</div>
        <div v-if="log.pain === 'Yes' || log.pain === 'TRUE' || log.pain === true" class="text-[8px] font-black text-red-500 uppercase mt-1 px-1.5 py-0.5 bg-red-500/10 rounded border border-red-500/20">Pain Recorded</div>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue

createApp({
  setup() {
    // --- API & State ---
    const BASE_URL = 'https://api.sheety.co/c1fb791480e9ebd8137b59f1a8c90cec/gymApp';
    const user = ref('JW');
    const userTimers = ref({ JW: 0, EP: 0 });
    const intervals = { JW: null, EP: null };
    const loading = ref(false);
    const syncing = ref(false);
    const rawLogs = ref([]);
    const form = ref({ exercise: '', weight: '', reps: '', duration: '', rest: 90, pain: false });

    // --- Action Library (Full ÂõûÊ≠∏) ---
    const actionLibrary = {
      JW: {
        "Chest": ["Incline Bench Press", "Flat Bench Press", "Dumbbell Flyes", "Cable Cross", "Push-ups"],
        "Back": ["Pull-ups", "Lat Pulldown", "Seated Row", "Barbell Row", "Face Pulls", "Deadlift"],
        "Shoulder": ["Military Press", "Lateral Raises", "Front Raises", "Reverse Fly", "Arnold Press"],
        "Legs": ["Squat", "Leg Press", "Leg Extension", "Leg Curl", "Calf Raises", "Split Squat"],
        "Arms": ["Bicep Curl", "Hammer Curl", "Tricep Pushdown", "Skull Crusher", "Dips"],
        "Cardio/Timed": ["Plank", "L-Sit", "Incline Treadmill", "Rowing Machine", "Battle Ropes", "Assault Bike", "Sprints", "Box Jumps", "Burpees", "Mountain Climbers"]
      },
      EP: {
        "Rehab/Correction": ["Glute Bridge", "Dead Bug", "Bird Dog", "Wall Slides", "Cat-Cow", "Pelvic Tilt", "Clamshells", "Scapular Squeeze"],
        "Cardio/Time": ["Plank", "Side Plank", "Elliptical", "Brisk Walk", "Stationary Bike", "Swimming", "Stairmaster"],
        "Core": ["Russian Twist", "Mountain Climbers", "Hollow Hold", "Hanging Leg Raise", "Ab Wheel"],
        "Lower Body": ["Bodyweight Squat", "Lunges", "Step-ups", "Goblet Squat", "Leg Raises", "Hip Thrust"],
        "Upper Body": ["Kneeling Push-ups", "Band Pull-aparts", "Light Row", "TRX Row", "Seated Y-Raise"]
      }
    };
    
    // Default Exercise
    form.value.exercise = actionLibrary.JW["Chest"][0];

    // --- Logic Functions ---
    const isTimed = computed(() => {
      const e = form.value.exercise.toLowerCase();
      return ["plank", "treadmill", "bike", "walk", "sit", "hold", "swimming", "stair", "sprint", "climb"].some(k => e.includes(k));
    });

    const fetchHistory = async (isBackground = false) => {
      if (!isBackground) syncing.value = true;
      try {
        const sheetName = user.value.toLowerCase() + 'logs';
        const res = await fetch(`${BASE_URL}/${sheetName}`);
        if (!res.ok) return;
        const data = await res.json();
        rawLogs.value = data[sheetName] || [];
      } catch (e) { console.error("Sync Error:", e); }
      finally { syncing.value = false; }
    };

    const logData = async () => {
      if (loading.value) return;
      loading.value = true;

      const sheetName = user.value.toLowerCase() + 'logs';
      const rootKey = user.value.toLowerCase() + 'log'; 
      
      const payload = {
        [rootKey]: {
          date: new Date().toLocaleDateString('zh-HK'),
          user: user.value,
          exercise: form.value.exercise,
          weight: Number(form.value.weight) || 0,
          reps: Number(form.value.reps) || 0,
          duration: Number(form.value.duration) || 0,
          rest: Number(form.value.rest) || 0,
          pain: form.value.pain ? "Yes" : "No"
        }
      };

      try {
        const response = await fetch(`${BASE_URL}/${sheetName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errData = await response.json();
          throw new Error(JSON.stringify(errData));
        }

        // Success: Start Timer & Reset Form
        startTimer(form.value.rest);
        await fetchHistory();
        form.value.weight = ''; form.value.reps = ''; form.value.duration = ''; form.value.pain = false;
      } catch (e) {
        alert(`‚ùå ÂÑ≤Â≠òÂ§±Êïó\nÂéüÂõ†: ${e.message}\nË´ãÊ™¢Êü• Google Sheet Ê®ôÈ°åÊòØÂê¶ÁÇ∫ÂÖ®Â∞èÂØ´„ÄÇ`);
      } finally {
        loading.value = false;
      }
    };

    // Âº∑ÂäõÊ∏ÖÊ¥óË®àÊôÇÂô®ÈÇèËºØ
    const startTimer = (s) => {
      // ÂÅúÊ≠¢ÊâÄÊúâÂèØËÉΩÂ≠òÂú®ÁöÑË®àÊôÇÂô®
      if (intervals.JW) { clearInterval(intervals.JW); intervals.JW = null; }
      if (intervals.EP) { clearInterval(intervals.EP); intervals.EP = null; }
      
      userTimers.value[user.value] = s;
      
      intervals[user.value] = setInterval(() => {
        if (userTimers.value[user.value] > 0) {
          userTimers.value[user.value]--;
        } else {
          clearInterval(intervals[user.value]);
          intervals[user.value] = null;
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
      }, 1000);
    };

    const skipRest = () => {
      if (intervals[user.value]) {
        clearInterval(intervals[user.value]);
        intervals[user.value] = null;
      }
      userTimers.value[user.value] = 0;
    };

    const switchUser = (u) => {
      user.value = u;
      form.value.exercise = Object.values(actionLibrary[u])[0][0];
      fetchHistory();
    };

    // --- Calendar & Utils ---
    const now = new Date();
    const currentMonthName = now.toLocaleString('default', { month: 'long' });
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const calendarOffset = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
    const isToday = (d) => d === now.getDate() && now.getMonth() === new Date().getMonth();
    
    const hasLog = (d) => {
      const dStr = new Date(now.getFullYear(), now.getMonth(), d).toLocaleDateString('zh-HK');
      return rawLogs.value.some(l => l.date === dStr);
    };
    
    const getDayStats = (d) => {
      const dStr = new Date(now.getFullYear(), now.getMonth(), d).toLocaleDateString('zh-HK');
      const logs = rawLogs.value.filter(l => l.date === dStr);
      return { hasPain: logs.some(l => l.pain === 'Yes' || l.pain === 'TRUE' || l.pain === true) };
    };

    const todayLogs = computed(() => {
      const today = new Date().toLocaleDateString('zh-HK');
      return rawLogs.value.filter(l => l.date === today).reverse();
    });

    const dailyVol = computed(() => todayLogs.value.reduce((acc, l) => acc + (Number(l.weight) * Number(l.reps) || 0), 0));
    const formatVol = (v) => v >= 1000 ? (v/1000).toFixed(1)+'k' : v;

    const streak = computed(() => {
      if (!rawLogs.value.length) return 0;
      const dates = new Set(rawLogs.value.map(l => l.date));
      let count = 0, d = new Date();
      if (!dates.has(d.toLocaleDateString('zh-HK'))) d.setDate(d.getDate() - 1);
      while (dates.has(d.toLocaleDateString('zh-HK'))) { count++; d.setDate(d.getDate() - 1); }
      return count;
    });

    onMounted(() => {
      fetchHistory();
      // Â§öË£ùÁΩÆÂêåÊ≠•ÔºöÊØè 60 ÁßíËá™ÂãïÂæåÂè∞Âà∑Êñ∞Ê≠∑Âè≤Á¥ÄÈåÑ
      setInterval(() => fetchHistory(true), 60000);
    });

    return { 
      user, userTimers, form, actionLibrary, loading, syncing,
      daysInMonth, calendarOffset, isToday, hasLog, getDayStats,
      switchUser, streak, todayLogs, isTimed, skipRest, logData,
      dailyVol, formatVol, currentMonthName
    }
  }
}).mount('#app')
</script>
</body>
</html>