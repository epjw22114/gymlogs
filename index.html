<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Power Log v5.5 - Ultimate Uncut Edition</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
    .font-digital { font-family: 'Orbitron', sans-serif; }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8); }
    .day-active { background: rgba(163, 230, 53, 0.25); border-radius: 12px; color: #a3e635 !important; box-shadow: inset 0 0 10px rgba(163, 230, 53, 0.1); }
    .animate-fadeIn { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .custom-scroll::-webkit-scrollbar { width: 0px; background: transparent; }
    .btn-active-jw { background: #a3e635; color: #000; box-shadow: 0 0 20px rgba(163, 230, 53, 0.4); }
    .btn-active-ep { background: #f97316; color: #fff; box-shadow: 0 0 20px rgba(249, 115, 22, 0.4); }
  </style>
</head>
<body>

<div id="app">
  <div v-if="!isAuthenticated" class="min-h-screen flex items-center justify-center p-6 bg-slate-950 relative overflow-hidden">
    <div class="absolute w-64 h-64 bg-lime-500/10 rounded-full blur-[100px] -top-20 -left-20"></div>
    <div class="w-full max-w-xs text-center space-y-10 animate-fadeIn z-10">
      <div class="space-y-2">
        <h1 class="text-5xl font-black italic text-lime-400 tracking-tighter italic">POWER LOG</h1>
        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.4em]">Biometric Secure Access</p>
      </div>
      <div class="space-y-6">
        <input type="password" v-model="passInput" @input="checkPass" placeholder="••••" 
               class="w-full bg-slate-900/50 border-2 border-slate-800 rounded-[2rem] p-8 text-center text-4xl font-digital tracking-[0.4em] text-lime-400 outline-none focus:border-lime-400 backdrop-blur-md transition-all">
        <div v-if="passError" class="text-red-500 text-[10px] font-black uppercase tracking-widest animate-bounce">Access Denied - Try Again</div>
      </div>
    </div>
  </div>

  <div v-else class="max-w-md mx-auto min-h-screen p-4 pb-28 animate-fadeIn">
    
    <header class="flex justify-between items-center mb-8 pt-6 px-2">
      <div class="space-y-1">
        <h1 class="text-2xl font-black italic tracking-tighter text-lime-400">POWER LOG <span class="text-slate-700 text-xs not-italic font-bold ml-1">V5.5</span></h1>
        <div class="flex items-center gap-3">
          <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span> {{ streak }} Day Streak
          </div>
          <div v-if="syncing" class="text-[9px] font-black text-lime-500 uppercase animate-pulse">● Cloud Syncing</div>
        </div>
      </div>
      <div class="bg-slate-900 p-1.5 rounded-[1.5rem] flex border border-slate-800 shadow-2xl">
        <button v-for="u in ['JW', 'EP']" @click="switchUser(u)" 
                :class="user === u ? (u === 'JW' ? 'btn-active-jw' : 'btn-active-ep') : 'text-slate-600'"
                class="px-7 py-2.5 rounded-xl font-black transition-all text-[11px] uppercase tracking-tighter">{{ u }}</button>
      </div>
    </header>

    <div v-if="userTimers[user] > 0" class="mb-8 rounded-[3rem] overflow-hidden shadow-[0_30px_60px_-15px_rgba(0,0,0,0.7)] animate-fadeIn border border-white/5">
      <div :class="user === 'JW' ? 'bg-lime-400 text-black' : 'bg-orange-500 text-white'" class="p-10 text-center relative">
        <div class="absolute top-0 left-0 h-1.5 bg-black/10 w-full">
          <div class="h-full bg-black/20" :style="{width: (userTimers[user]/form.rest)*100 + '%'}"></div>
        </div>
        <p class="text-[10px] font-black uppercase mb-3 opacity-60 tracking-[0.5em]">Rest Interval</p>
        <div class="text-8xl font-digital leading-none mb-8 tracking-tighter">{{ userTimers[user] }}<span class="text-2xl ml-1">s</span></div>
        <button @click="skipRest" class="bg-black/10 hover:bg-black/20 px-12 py-3.5 rounded-full text-[10px] font-black uppercase border border-black/10 backdrop-blur-md transition-all active:scale-90">Skip Rest</button>
      </div>
    </div>

    <div class="glass rounded-[2.5rem] p-7 mb-8 relative border-t border-white/10">
      <div class="space-y-7">
        <div class="relative">
          <label class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] ml-2 mb-3 block">Training Action</label>
          <div class="relative">
            <select v-model="form.exercise" class="w-full bg-slate-800/60 rounded-2xl p-5 text-sm font-bold outline-none ring-1 ring-slate-700/50 text-white appearance-none focus:ring-2 focus:ring-lime-400/50">
              <optgroup v-for="(list, cat) in actionLibrary[user]" :label="cat" class="bg-slate-900 text-slate-500">
                <option v-for="ex in list" :value="ex">{{ ex }}</option>
              </optgroup>
            </select>
            <div class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">▼</div>
          </div>
        </div>

        <div v-if="isCardio" class="grid grid-cols-2 gap-5 animate-fadeIn">
          <div class="space-y-3">
            <label class="text-[10px] font-black text-blue-400 uppercase tracking-widest ml-2">Duration (Min)</label>
            <input v-model.number="form.duration" type="number" inputmode="numeric" class="w-full bg-slate-900/80 rounded-3xl p-6 text-3xl font-black text-center text-blue-400 outline-none ring-1 ring-slate-700 focus:ring-blue-500">
          </div>
          <div class="space-y-3">
            <label class="text-[10px] font-black text-blue-400 uppercase tracking-widest ml-2">Distance (KM)</label>
            <input v-model.number="form.weight" type="number" step="0.1" inputmode="decimal" class="w-full bg-slate-900/80 rounded-3xl p-6 text-3xl font-black text-center text-blue-400 outline-none ring-1 ring-slate-700 focus:ring-blue-500">
          </div>
        </div>

        <div v-else-if="isTimed" class="space-y-3 animate-fadeIn">
          <label class="text-[10px] font-black text-lime-400 uppercase tracking-widest ml-2">Time Hold (Sec)</label>
          <input v-model.number="form.duration" type="number" inputmode="numeric" class="w-full bg-slate-900/80 rounded-[2rem] p-8 text-5xl font-black text-center text-lime-400 outline-none ring-1 ring-slate-700 focus:ring-lime-400">
        </div>

        <div v-else class="grid grid-cols-2 gap-5 animate-fadeIn">
          <div class="space-y-3">
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Load (kg)</label>
            <input v-model.number="form.weight" type="number" step="0.5" inputmode="decimal" placeholder="0.0" class="w-full bg-slate-900/80 rounded-3xl p-6 text-3xl font-black text-center outline-none ring-1 ring-slate-700 focus:ring-lime-400 transition-all">
          </div>
          <div class="space-y-3">
            <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-2">Reps</label>
            <input v-model.number="form.reps" type="number" inputmode="numeric" placeholder="0" class="w-full bg-slate-900/80 rounded-3xl p-6 text-3xl font-black text-center outline-none ring-1 ring-slate-700 focus:ring-lime-400 transition-all">
          </div>
        </div>

        <div v-if="!isCardio" class="flex gap-2">
          <button v-for="t in [60, 90, 120, 180]" @click="form.rest = t"
                  :class="form.rest === t ? (user === 'JW' ? 'bg-lime-400 text-black' : 'bg-orange-500 text-white') : 'bg-slate-800 text-slate-500'"
                  class="flex-1 py-3.5 rounded-xl font-black text-[10px] uppercase transition-all">{{ t }}s</button>
        </div>

        <div v-if="user === 'EP'" class="flex justify-between items-center bg-red-500/5 p-5 rounded-2xl border border-red-500/10">
          <div class="leading-tight">
            <span class="block text-xs font-black text-red-500 italic">Discomfort / Pain?</span>
            <span class="text-[8px] text-red-500/40 uppercase font-bold tracking-widest">Post-set Assessment</span>
          </div>
          <input type="checkbox" v-model="form.pain" class="w-7 h-7 accent-red-500 rounded-lg">
        </div>

        <button @click="logData" :disabled="loading" 
                class="w-full bg-white text-black font-black py-6 rounded-[2rem] active:scale-[0.97] transition-all shadow-2xl uppercase tracking-[0.3em] text-[11px]">
          {{ loading ? 'Synchronizing...' : 'Log Activity & Start Rest' }}
        </button>
      </div>
    </div>

    <div class="glass rounded-[2.5rem] p-7 mb-8 shadow-2xl text-center border-b border-white/5">
      <div class="flex justify-between items-center mb-8 px-2">
        <span class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Consistency Tracker</span>
        <span class="text-[9px] font-black text-slate-400 uppercase bg-slate-800/80 px-4 py-1.5 rounded-full tracking-tighter">{{ currentMonthName }}</span>
      </div>
      <div class="grid grid-cols-7 gap-y-5">
        <div v-for="d in ['S','M','T','W','T','F','S']" class="text-[10px] font-black text-slate-700 uppercase">{{ d }}</div>
        <div v-for="e in calendarOffset" class="aspect-square"></div>
        <div v-for="d in daysInMonth" :key="d" @click="selectedDate = getFormattedDate(d)"
             class="relative py-2.5 cursor-pointer transition-all" :class="{'day-active': selectedDate === getFormattedDate(d)}">
          <span :class="isToday(d) ? 'text-lime-400 font-black ring-2 ring-lime-400/20 px-2 py-1 rounded-xl bg-lime-400/5' : 'text-slate-600'" class="text-xs font-bold">{{ d }}</span>
          <div v-if="hasLog(d)" :class="user === 'JW' ? 'bg-lime-400 shadow-[0_0_8px_#a3e635]' : 'bg-orange-500 shadow-[0_0_8px_#f97316]'" class="w-1.5 h-1.5 rounded-full mx-auto mt-2.5"></div>
        </div>
      </div>
    </div>

    <div class="space-y-8">
      <section class="animate-fadeIn">
        <div class="flex justify-between items-end px-4 mb-5">
          <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-[0.2em]">{{ selectedDate === todayDate ? "Today's" : selectedDate }} Performance</h3>
          <div v-if="filteredLogs.length" class="text-right">
            <span class="text-[9px] font-bold text-slate-600 uppercase block">Total Volume</span>
            <span class="text-lg font-black italic tracking-tighter text-white">{{ formatVol(dailyVol) }}<span class="text-[10px] ml-1 text-slate-600">KG</span></span>
          </div>
        </div>
        
        <div v-if="filteredLogs.length === 0" class="text-center py-16 text-slate-800 text-[11px] font-black uppercase border-2 border-dashed border-slate-900 rounded-[3rem] tracking-widest mx-2">
          No Activity Recorded
        </div>
        
        <div v-for="(log, i) in filteredLogs" :key="i" 
             :class="log.pain === 'Yes' ? 'border-red-500/50 bg-red-500/5' : 'border-slate-800 bg-slate-900/40'"
             class="border-l-[8px] p-6 rounded-[1.8rem] flex justify-between items-center shadow-xl mb-5 animate-fadeIn">
          <div>
            <div class="font-black text-sm uppercase mb-1.5 tracking-tight text-slate-200">{{ log.exercise }}</div>
            <div class="text-[10px] font-bold uppercase tracking-widest">
              <span v-if="log.duration > 0 && log.weight > 0" class="text-blue-400">{{ log.duration }} MIN / {{ log.weight }} KM</span>
              <span v-else-if="log.duration > 0" class="text-lime-400">{{ log.duration }}s TIME HOLD</span>
              <span v-else class="text-slate-500">{{ log.weight }}KG <span class="text-slate-700 mx-1">×</span> {{ log.reps }} REPS</span>
            </div>
          </div>
          <div v-if="log.weight > 0 && log.reps > 0" class="text-right">
            <div class="text-xs font-black text-slate-500 italic tracking-tighter">{{ log.weight * log.reps }}KG</div>
            <div v-if="log.pain === 'Yes'" class="text-[8px] text-red-500 font-black mt-1 uppercase">Pain Alert</div>
          </div>
        </div>
      </section>

      <section v-if="pastSevenDaysLogs.length > 0" class="animate-fadeIn">
        <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-[0.2em] px-4 mb-5">Weekly Briefing</h3>
        <div class="space-y-3 opacity-70">
          <div v-for="day in pastSevenDays" :key="day" v-show="getLogsByDate(day).length" class="bg-slate-900/30 p-5 rounded-[1.5rem] flex justify-between items-center border border-slate-800/50">
            <div class="text-[11px] font-black text-slate-500 italic">{{ day.split('/')[1] }}/{{ day.split('/')[0] }}</div>
            <div class="flex flex-wrap justify-end gap-2 max-w-[200px]">
              <span v-for="l in getLogsByDate(day).slice(0,3)" class="text-[8px] bg-slate-800/80 px-2.5 py-1 rounded-lg text-slate-400 uppercase font-black tracking-tighter border border-white/5">{{ l.exercise }}</span>
            </div>
          </div>
        </div>
      </section>
    </div>

  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue

createApp({
  setup() {
    const BASE_URL = 'https://api.sheety.co/c1fb791480e9ebd8137b59f1a8c90cec/gymApp';
    const MASTER_PASS = "0303";
    
    // Core States
    const isAuthenticated = ref(false);
    const passInput = ref("");
    const passError = ref(false);
    const user = ref('JW');
    const loading = ref(false);
    const syncing = ref(false);
    const rawLogs = ref([]);
    const todayDate = new Date().toLocaleDateString('zh-HK');
    const selectedDate = ref(todayDate);
    
    // Timer System
    const userTimers = ref({ JW: 0, EP: 0 });
    const intervals = { JW: null, EP: null };
    
    // Form State
    const form = ref({ exercise: '', weight: '', reps: '', duration: '', rest: 90, pain: false });

    // --- 完整動作庫 (50+ 項目，不刪減) ---
    const actionLibrary = {
      JW: {
        "Chest (Push)": ["Incline Bench Press", "Flat Bench Press", "Dumbbell Flyes", "Cable Cross", "Push-ups", "Chest Press Machine", "Dips (Chest Focus)"],
        "Back (Pull)": ["Pull-ups", "Lat Pulldown", "Seated Row", "Barbell Row", "Face Pulls", "Deadlift", "Single Arm DB Row", "Hyperextensions", "T-Bar Row"],
        "Shoulders": ["Military Press", "Lateral Raises", "Front Raises", "Reverse Fly", "Arnold Press", "Upright Row", "Shrugs"],
        "Legs": ["Squat", "Leg Press", "Leg Extension", "Leg Curl", "Calf Raises", "Split Squat", "Romanian Deadlift", "Goblet Squat", "Lunge"],
        "Arms": ["Bicep Curl", "Hammer Curl", "Tricep Pushdown", "Skull Crusher", "Preacher Curl", "Concentration Curl", "Overhead Extension"],
        "Cardio (Min/KM)": ["Incline Treadmill", "Rowing Machine", "Assault Bike", "Sprints", "Outdoor Run", "Stationary Bike", "Box Jumps", "Burpees"],
        "Static (Seconds)": ["Plank", "L-Sit", "Wall Sit", "Dead Hang", "Hollow Hold", "Side Plank"]
      },
      EP: {
        "Rehab/Light": ["Glute Bridge", "Dead Bug", "Bird Dog", "Wall Slides", "Cat-Cow", "Pelvic Tilt", "Clamshells", "Scapular Squeeze", "Shoulder External Rotation", "Chin Tucks"],
        "Cardio (Min/KM)": ["Elliptical", "Brisk Walk", "Stationary Bike", "Swimming", "Stairmaster", "Yoga Flow", "Tai Chi"],
        "Core": ["Russian Twist", "Mountain Climbers", "Plank Shoulder Taps", "Bicycle Crunches", "Leg Drops", "Hanging Leg Raise", "Ab Wheel"],
        "Upper Body": ["Kneeling Push-ups", "Band Pull-aparts", "Light Row", "TRX Row", "Seated Y-Raise", "Wall Push-ups", "Lat Pulldown (Light)"],
        "Lower Body": ["Bodyweight Squat", "Lunges", "Step-ups", "Hip Thrust", "Standing Calf Raises", "Fire Hydrants"]
      }
    };
    
    form.value.exercise = actionLibrary.JW["Chest (Push)"][0];

    // Helper: 判定動作類型
    const isCardio = computed(() => ["treadmill", "rowing", "bike", "sprints", "run", "elliptical", "walk", "swimming", "stair", "box jumps", "burpees"].some(k => form.value.exercise.toLowerCase().includes(k)));
    const isTimed = computed(() => ["plank", "l-sit", "sit", "hold", "hang"].some(k => form.value.exercise.toLowerCase().includes(k)));

    // 登入邏輯
    const checkPass = () => { 
      if (passInput.value === MASTER_PASS) { 
        isAuthenticated.value = true; 
        localStorage.setItem('gym_auth', 'true'); 
        fetchHistory(); 
      } else if (passInput.value.length >= 4) {
        passError.value = true;
        setTimeout(() => { passError.value = false; passInput.value = ""; }, 1200);
      }
    };

    // 數據同步
    const fetchHistory = async () => {
      syncing.value = true;
      try {
        const sheetName = user.value.toLowerCase() + 'logs';
        const res = await fetch(`${BASE_URL}/${sheetName}`);
        const data = await res.json();
        rawLogs.value = data[sheetName] || [];
      } catch (e) { console.error("Cloud Sync Error"); }
      finally { syncing.value = false; }
    };

    const logData = async () => {
      if (loading.value) return;
      loading.value = true;
      const sheetName = user.value.toLowerCase() + 'logs';
      const rootKey = user.value.toLowerCase() + 'log'; 
      const payload = { [rootKey]: { date: todayDate, user: user.value, exercise: form.value.exercise, weight: Number(form.value.weight)||0, reps: Number(form.value.reps)||0, duration: Number(form.value.duration)||0, rest: Number(form.value.rest)||90, pain: form.value.pain?"Yes":"No" } };
      
      try {
        const res = await fetch(`${BASE_URL}/${sheetName}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error();
        if (!isCardio.value) startTimer(form.value.rest);
        selectedDate.value = todayDate;
        await fetchHistory();
        form.value.weight = ''; form.value.reps = ''; form.value.duration = ''; form.value.pain = false;
        if (navigator.vibrate) navigator.vibrate(50);
      } catch (e) { alert("儲存失敗：網絡連接不穩定"); }
      finally { loading.value = false; }
    };

    // 計時器邏輯
    const startTimer = (s) => {
      userTimers.value[user.value] = s;
      if (intervals[user.value]) clearInterval(intervals[user.value]);
      intervals[user.value] = setInterval(() => {
        if (userTimers.value[user.value] > 0) userTimers.value[user.value]--;
        else {
          clearInterval(intervals[user.value]);
          if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
      }, 1000);
    };

    const skipRest = () => { userTimers.value[user.value] = 0; clearInterval(intervals[user.value]); };

    const switchUser = (u) => { 
      user.value = u; 
      form.value.exercise = Object.values(actionLibrary[u])[0][0];
      fetchHistory(); 
    };

    // 日曆系統
    const now = new Date();
    const currentMonthName = now.toLocaleString('default', { month: 'long' });
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const calendarOffset = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
    const getFormattedDate = (d) => new Date(now.getFullYear(), now.getMonth(), d).toLocaleDateString('zh-HK');
    const isToday = (d) => getFormattedDate(d) === todayDate;
    const hasLog = (d) => rawLogs.value.some(l => l.date === getFormattedDate(d));

    const getLogsByDate = (dateStr) => rawLogs.value.filter(l => l.date === dateStr).reverse();
    const filteredLogs = computed(() => getLogsByDate(selectedDate.value));
    
    // 過去七天
    const pastSevenDays = computed(() => {
      return [...Array(7).keys()].map(i => {
        const d = new Date();
        d.setDate(d.getDate() - i);
        return d.toLocaleDateString('zh-HK');
      });
    });
    const pastSevenDaysLogs = computed(() => rawLogs.value.filter(l => pastSevenDays.value.includes(l.date)));

    // 數據展示輔助
    const dailyVol = computed(() => filteredLogs.value.reduce((acc, l) => acc + (Number(l.weight) * Number(l.reps) || 0), 0));
    const formatVol = (v) => v >= 1000 ? (v/1000).toFixed(1)+'k' : v;
    const streak = computed(() => {
      const dates = new Set(rawLogs.value.map(l => l.date));
      let count = 0, d = new Date();
      if (!dates.has(todayDate)) d.setDate(d.getDate() - 1);
      while (dates.has(d.toLocaleDateString('zh-HK'))) { count++; d.setDate(d.getDate() - 1); }
      return count;
    });

    onMounted(() => { if (localStorage.getItem('gym_auth') === 'true') { isAuthenticated.value = true; fetchHistory(); } });

    return { 
      isAuthenticated, passInput, passError, checkPass, user, form, actionLibrary, loading, syncing, switchUser, 
      daysInMonth, calendarOffset, currentMonthName, selectedDate, todayDate, getFormattedDate, isToday, hasLog,
      filteredLogs, dailyVol, formatVol, streak, pastSevenDays, getLogsByDate, pastSevenDaysLogs, isCardio, isTimed, logData, userTimers, skipRest
    }
  }
}).mount('#app')
</script>
</body>
</html>